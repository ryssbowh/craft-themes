{"version":3,"sources":["blocks.js"],"names":["_typeof","Craft","Themes","Base","extend","undefined","$targetRegions","$regions","$blocks","$saveBtn","$","isSaving","init","this","_this","each","find","block","blockDragDrop","Garnish","DragDrop","dropTargets","activeDropTargetClass","_initEvents","helperBaseZindex","proxy","$file","helperOpacity","onDragStop","addItems","helper","click","next","_getFileDragHelper","toggleClass","e","preventDefault","_save","attr","addClass","data","regions","a","index","region","regionName","blocks","blockHandle","blockProvider","active","hasClass","order","message","error","cp","displayError","sendActionRequest","removeClass","_populateBlockIds","layout","Object","keys","forEach","key","id","$block","$region","change","$element","$outerContainer","appendTo","$bod","removeItems","remove","$draggee","$dropTargets","$activeDropTarget","clone","settings","_onDragStop","append","css","returnHelpersToDraggees","Blocks"],"mappings":"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","file":"blocks.js","sourcesContent":["if (typeof Craft.Themes === typeof undefined) {\n    Craft.Themes = {};\n}\n\nCraft.Themes.Blocks = Garnish.Base.extend({ \n\t$blocks: null,\n\t$targetRegions: null,\n\t$regions: null,\n\t$saveBtn: null,\n\tisSaving: false,\n\n\tinit: function () {\n\t\tthis.$blocks = $('#theme-blocks .region-blocks .block, #theme-blocks .theme-sidebar .block');\n\t\tthis.$targetRegions = $('#theme-blocks .region-blocks');\n\t\tthis.$regions = $('.theme-regions .region');\n\t\tthis.$saveBtn = $('#toolbar .submit');\n\t\tlet _this = this;\n\t\t$.each(this.$targetRegions.find('.block'), function (block) {\n\t\t\t_this._initEvents($(block));\n\t\t});\n\t\tthis.blockDragDrop = new Garnish.DragDrop({\n            dropTargets: this.$targetRegions,\n            activeDropTargetClass: 'drop-active',\n            helperOpacity: 0.75,\n            helperBaseZindex: 800,\n            onDragStop: $.proxy(this, '_onDragStop'),\n            helper: $.proxy(function($file) {\n\t\t\t\treturn this._getFileDragHelper($file);\n\t\t\t}, this),\n        });\n        this.blockDragDrop.addItems(this.$blocks);\n        $('#theme-blocks .theme-sidebar h3').click(function(){\n        \t$(this).next().slideToggle('fast');\n        \t$(this).toggleClass('closed');\n        });\n        this.$saveBtn.click(function(e){\n        \te.preventDefault();\n        \tif (!_this.isSaving) {\n        \t\t_this._save($(this));\n        \t}\n        })\n\t},\n\n\t_save: function (a) {\n\t\tlet _this = this;\n\t\tthis.isSaving = true;\n\t\tthis.$saveBtn.attr('disabled', true).addClass('loading');\n\t\tlet data = {regions: {}};\n\t\t$.each(this.$regions, function (index, region) {\n\t\t\tlet regionName = $(region).data('handle');\n\t\t\tlet blocks = [];\n\t\t\t$.each($(region).find('.block'), function (index, block) {\n\t\t\t\tblocks.push({\n\t\t\t\t\tblockHandle: $(block).data('handle'),\n\t\t\t\t\tid: $(block).data('id'),\n\t\t\t\t\tregion: regionName,\n\t\t\t\t\tblockProvider: $(block).data('provider'),\n\t\t\t\t\tactive: $(block).find('.lightswitch').hasClass('on'),\n\t\t\t\t\torder: index\n\t\t\t\t});\n\t\t\t});\n\t\t\tdata.regions[regionName] = blocks;\n\t\t});\n\t\tCraft.sendActionRequest('POST', a.attr('href'), {data: data})\n\t\t\t.then(function (response) {\n\t\t\t\tCraft.cp.displayNotice(response.data.message);\n\t\t\t\t_this._populateBlockIds(response.data.layout);\n\t\t\t}).catch(function (error) {\n\t\t\t\tCraft.cp.displayError(error);\n\t\t\t}).finally(function(data){\n\t\t\t\t_this.isSaving = false;\n\t\t\t\t_this.$saveBtn.attr('disabled', false).removeClass('loading');\n\t\t\t});\n\t},\n\n\t_populateBlockIds: function (layout) {\n\t\tlet _this = this;\n\t\tObject.keys(layout.regions).forEach(function (region) {\n\t\t\tlet $region = _this.$regions.filter('[data-handle='+region+']');\n\t\t\tlayout.regions[region].forEach(function (block, key) {\n\t\t\t\t$region.find('.block:nth-child('+(key + 1)+')').data('id', block.id);\n\t\t\t});\n\t\t});\n\t},\n\n\t_initEvents ($block) {\n\t\tlet _this = this;\n\t\t$block.find('.delete').click(function () {\n\t\t\t_this.blockDragDrop.removeItems($block);\n\t\t\t$block.remove();\n\t\t});\n\t\tCraft.initUiElements($block);\n\t\t$block.find('.lightswitch').change(function () {\n\t\t\t$block.toggleClass('disabled');\n\t\t});\n\t},\n\n\t_getFileDragHelper: function($element) {\n        let $outerContainer = $('<div class=\"theme-block-drap-helper\"/>').appendTo(Garnish.$bod);\n\n        $element.clone().appendTo($outerContainer);\n\n        return $outerContainer;\n\t},\n\n\t_onDragStop: function($element) {\n\t\tif (this.blockDragDrop.$dropTargets && this.blockDragDrop.$activeDropTarget) {\n\t\t\tlet $draggee = this.blockDragDrop.$draggee;\n\t\t\tif ($draggee.hasClass('original')) {\n\t\t\t\t$draggee = $draggee.clone().removeClass('original');\n\t\t\t\tthis.blockDragDrop.addItems($draggee);\n\t\t\t\tthis._initEvents($draggee);\n\t\t\t}\n            this.blockDragDrop.$activeDropTarget.removeClass(this.blockDragDrop.settings.activeDropTargetClass);\n            this.blockDragDrop.$activeDropTarget.append($draggee);\n            this.blockDragDrop.fadeOutHelpers();\n            $draggee.css('visibility', 'visible');\n        } else {\n        \tthis.blockDragDrop.returnHelpersToDraggees();\n        }\n\t},\n});\n\n$(function(){\n\tnew Craft.Themes.Blocks();\n});"]}