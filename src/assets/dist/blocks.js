"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}"undefined"===_typeof(Craft.Themes)&&(Craft.Themes={}),Craft.Themes.Blocks=Garnish.Base.extend({$blocks:null,$targetRegions:null,$regions:null,$saveBtn:null,isSaving:!1,init:function(){this.$blocks=$("#theme-blocks .region-blocks .block, #theme-blocks .theme-sidebar .block"),this.$targetRegions=$("#theme-blocks .region-blocks"),this.$regions=$(".theme-regions .region"),this.$saveBtn=$("#toolbar .submit");var e=this;$.each(this.$targetRegions.find(".block"),function(t){e._initEvents($(t))}),this.blockDragDrop=new Garnish.DragDrop({dropTargets:this.$targetRegions,activeDropTargetClass:"drop-active",helperOpacity:.75,helperBaseZindex:800,onDragStop:$.proxy(this,"_onDragStop"),helper:$.proxy(function(t){return this._getFileDragHelper(t)},this)}),this.blockDragDrop.addItems(this.$blocks),$("#theme-blocks .theme-sidebar h3").click(function(){$(this).next().slideToggle("fast"),$(this).toggleClass("closed")}),this.$saveBtn.click(function(t){t.preventDefault(),e.isSaving||e._save($(this))})},_save:function(t){var e=this;this.isSaving=!0,this.$saveBtn.attr("disabled",!0).addClass("loading");var a={regions:{}};$.each(this.$regions,function(t,e){var i=$(e).data("handle"),o=[];$.each($(e).find(".block"),function(t,e){o.push({blockHandle:$(e).data("handle"),id:$(e).data("id"),region:i,blockProvider:$(e).data("provider"),active:$(e).find(".lightswitch").hasClass("on"),order:t})}),a.regions[i]=o}),Craft.sendActionRequest("POST",t.attr("href"),{data:a}).then(function(t){Craft.cp.displayNotice(t.data.message),e._populateBlockIds(t.data.layout)}).catch(function(t){Craft.cp.displayError(t)}).finally(function(t){e.isSaving=!1,e.$saveBtn.attr("disabled",!1).removeClass("loading")})},_populateBlockIds:function(e){var o=this;Object.keys(e.regions).forEach(function(t){var i=o.$regions.filter("[data-handle="+t+"]");e.regions[t].forEach(function(t,e){i.find(".block:nth-child("+(e+1)+")").data("id",t.id)})})},_initEvents:function(t){var e=this;t.find(".delete").click(function(){e.blockDragDrop.removeItems(t),t.remove()}),Craft.initUiElements(t),t.find(".lightswitch").change(function(){t.toggleClass("disabled")})},_getFileDragHelper:function(t){var e=$('<div class="theme-block-drap-helper"/>').appendTo(Garnish.$bod);return t.clone().appendTo(e),e},_onDragStop:function(t){var e;this.blockDragDrop.$dropTargets&&this.blockDragDrop.$activeDropTarget?((e=this.blockDragDrop.$draggee).hasClass("original")&&(e=e.clone().removeClass("original"),this.blockDragDrop.addItems(e),this._initEvents(e)),this.blockDragDrop.$activeDropTarget.removeClass(this.blockDragDrop.settings.activeDropTargetClass),this.blockDragDrop.$activeDropTarget.append(e),this.blockDragDrop.fadeOutHelpers(),e.css("visibility","visible")):this.blockDragDrop.returnHelpersToDraggees()}}),$(function(){new Craft.Themes.Blocks});